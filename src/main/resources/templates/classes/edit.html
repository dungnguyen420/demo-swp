<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8">
    <title>Sửa lớp</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        .row { margin: 6px 0; }
        .slot-row { display: flex; gap: 8px; align-items: center; margin: 6px 0; }
        .slot-row input[type="date"], .slot-row select { padding: 4px; }
        .btn { padding: 6px 10px; border: none; border-radius: 6px; cursor: pointer; }
        .btn-add { background: #0d6efd; color: #fff; }
        .btn-del { background: #dc3545; color: #fff; }
        .btn-save { background: #198754; color: #fff; }
        .form-label { display: inline-block; width: 110px; }
    </style>
</head>
<body>
<h2>Sửa lớp</h2>

<!-- Thông báo -->
<div th:if="${errorMessage}" style="color:red" th:text="${errorMessage}"></div>
<div th:if="${message}" style="color:green" th:text="${message}"></div>

<!-- Form edit: bind vào 'dto' -->
<form th:action="@{|/classes/${clazz.id}/edit|}" th:object="${dto}" method="post">

    <div class="row">
        <label class="form-label" for="nameInput">Tên lớp</label>
        <input id="nameInput" type="text" th:field="*{name}" required>
    </div>

    <div class="row">
        <label class="form-label" for="descInput">Mô tả</label>
        <textarea id="descInput" th:field="*{description}" rows="3"></textarea>
    </div>

    <div class="row">
        <label class="form-label" for="capInput">Sức chứa</label>
        <input id="capInput" type="number" min="1" th:field="*{capacity}">
    </div>

    <hr>

    <h3>Lịch hiện có</h3>
    <table border="1" cellspacing="0" cellpadding="6">
        <thead>
        <tr>
            <th>Ngày</th>
            <th>Slot</th>
            <th>Giờ</th>
            <th>Trạng thái</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="s : ${clazz.schedules}">
            <td th:text="${s.slot.slotDate}">2025-10-14</td>
            <td th:text="${s.slot.slotNumber}">SLOT_1</td>
            <td>
                <span th:text="${s.slot.startTime}">06:00</span> -
                <span th:text="${s.slot.endTime}">08:00</span>
            </td>
            <td th:text="${s.status}">CONFIRMED</td>
        </tr>
        <tr th:if="${#lists.isEmpty(clazz.schedules)}">
            <td colspan="4">Chưa có lịch</td>
        </tr>
        </tbody>
    </table>

    <hr>

    <h3>Thêm lịch mới</h3>

    <!-- Container danh sách slot mới -->
    <div id="slotContainer">
        <!-- Render từ DTO: cần dto.newSlots có sẵn ít nhất 1 phần tử rỗng từ controller -->
        <div class="slot-row" th:each="r, stat : *{newSlots}">
            <label class="form-label">Ngày</label>
            <input type="date" th:field="*{newSlots[__${stat.index}__].date}" required>

            <label class="form-label" style="width:auto">Slot</label>
            <select th:field="*{newSlots[__${stat.index}__].slotNumber}" required>
                <option value="" disabled selected>Chọn slot</option>
                <option th:each="n : ${slotNumbers}" th:value="${n}" th:text="${n}">1</option>
            </select>


            <button type="button" class="btn btn-del" onclick="removeRow(this)">Xóa</button>
        </div>
    </div>

    <button type="button" class="btn btn-add" onclick="addRow()">+ Thêm dòng</button>

    <div class="row" style="margin-top:12px">
        <button type="submit" class="btn btn-save">Lưu</button>
        <a th:href="@{|/classes/${clazz.id}|}" style="margin-left:8px">Hủy</a>
    </div>
</form>

<script>
    // Thêm dòng slot mới
    function addRow() {
        const container = document.getElementById('slotContainer');
        const idx = container.querySelectorAll('.slot-row').length;

        const row = document.createElement('div');
        row.className = 'slot-row';
        row.innerHTML = `
      <label class="form-label">Ngày</label>
      <input type="date" name="newSlots[${idx}].date" required>

      <label class="form-label" style="width:auto">Slot</label>
      <select name="newSlots[${idx}].slotNumber" required>
        <option value="" disabled selected>Chọn slot</option>
        <option value="1">1</option><option value="2">2</option><option value="3">3</option>
        <option value="4">4</option><option value="5">5</option><option value="6">6</option>
      </select>

      <button type="button" class="btn btn-del" onclick="removeRow(this)">Xóa</button>
    `;
        container.appendChild(row);
    }

    // Xóa dòng và re-index name để Spring bind List<SlotRequest>
    function removeRow(btn) {
        const container = document.getElementById('slotContainer');
        btn.parentElement.remove();

        const rows = container.querySelectorAll('.slot-row');
        rows.forEach((r, i) => {
            const date = r.querySelector('input[type="date"]');
            const slot = r.querySelector('select');
            date.setAttribute('name', `newSlots[${i}].date`);
            slot.setAttribute('name', `newSlots[${i}].slotNumber`);
        });
    }
</script>

</body>
</html>
