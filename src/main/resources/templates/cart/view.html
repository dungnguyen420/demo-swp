<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GymCare - Gi·ªè h√†ng</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" th:href="@{/style.css}">

    <!-- CSRF cho AJAX -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<body>

<header class="navbar">
    <a th:href="@{/home}" class="logo">GymCare</a>
    <nav>
        <ul>
            <li><a th:href="@{/home}">Trang ch·ªß</a></li>
            <li><a th:href="@{/package}" >G√≥i t·∫≠p</a></li>
            <li><a th:href="@{/trainers}">Hu·∫•n luy·ªán vi√™n</a></li>
            <li><a th:href="@{/classes}">L·ªõp h·ªçc</a></li>
            <li><a th:href="@{/shop}">C·ª≠a h√†ng</a></li>
            <li sec:authorize="hasAnyRole('MANAGER')">
                <a th:href="@{/equipment/list}">C∆° s·ªü v·∫≠t ch·∫•t</a>
            </li>
            <li sec:authorize="hasRole('MANAGER')">
                <a th:href="@{/products/list}">Danh s√°ch s·∫£n ph·∫©m</a>
            </li>
        </ul>
    </nav>
    <div class="auth-section">
        <div sec:authorize="isAuthenticated()" class="profile-dropdown">
            <img th:src="@{/images/default-avatar.png}" alt="Avatar">
            <span sec:authentication="principal.username">Username</span>
            <ul class="dropdown-menu">
                <li><a th:href="@{/user/profile}"><i class="fas fa-user-circle"></i> H·ªì s∆° c√° nh√¢n</a></li>
                <li sec:authorize="hasRole('ADMIN')">
                    <a th:href="@{/auth/dashBoard}"><i class="fas fa-user-shield"></i> Trang qu·∫£n tr·ªã</a>
                <li >
                <li sec:authorize="hasRole('ADMIN')">
                    <a th:href="@{/managers}"><i class="fas fa-user-shield"></i> Qu·∫£n l√≠ </a>
                <li >
                    <a th:href="@{/my-schedule/personal}"><i class="fas fa-user"></i> L·ªãch PT c·ªßa t√¥i</a>
                </li>
                <li >
                    <a th:href="@{/my-schedule/classes}"><i class="fas fa-users"></i> L·ªõp h·ªçc c·ªßa t√¥i</a>
                </li>

                <li sec:authorize="hasAuthority('TRAINER')">
                    <a th:href="@{/my-schedule/teaching}"><i class="fas fa-chalkboard-teacher"></i> L·ªãch d·∫°y c·ªßa t√¥i</a>
                </li>
                <li class="logout">
                    <form th:action="@{/logout}" method="post">
                        <button type="submit">
                            <i class="fas fa-user"></i> ƒêƒÉng xu·∫•t
                        </button>
                    </form>
                </li>
                <li><a th:href="@{/orders/history}"><i class="fas fa-history"></i> L·ªãch s·ª≠ giao d·ªãch</a></li>
            </ul>
        </div>
        <a sec:authorize="!isAuthenticated()" th:href="@{/index}" class="cta-button">ƒêƒÉng nh·∫≠p</a>
    </div>
</header>

<main>
    <div class="page-container">

        <h2 class="page-title">üõí Gi·ªè h√†ng c·ªßa b·∫°n</h2>

        <div class="content-card">

            <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
            <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

            <div th:if="${cart == null || #lists.isEmpty(cart.items)}" class="empty-cart">
                <i class="fas fa-shopping-basket"></i>
                <h3>Gi·ªè h√†ng tr·ªëng</h3>
                <p>H√£y th√™m v√†i s·∫£n ph·∫©m tuy·ªát v·ªùi v√†o gi·ªè nh√©.</p>
                <a th:href="@{/shop}" class="cta-button">Ti·∫øp t·ª•c mua s·∫Øm</a>
            </div>

            <div th:if="${cart != null && !#lists.isEmpty(cart.items)}">

                <table class="data-table">
                    <thead>
                    <tr>
                        <th>T√™n s·∫£n ph·∫©m</th>
                        <th>ƒê∆°n gi√°</th>
                        <th>S·ªë l∆∞·ª£ng</th>
                        <th>Th√†nh ti·ªÅn</th>
                        <th>X√≥a</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="it : ${cart.items}">
                        <td data-label="S·∫£n ph·∫©m" th:text="${it.itemName}">T√™n SP</td>

                        <td data-label="ƒê∆°n gi√°"
                            th:text="${#numbers.formatDecimal(it.unitPrice, 0, 'COMMA', 0, 'POINT')} + ' VND'">
                            0
                        </td>

                        <!-- S·ªê L∆Ø·ª¢NG: ch·ªâ input, kh√¥ng c·∫ßn n√∫t sync, d√πng AJAX -->
                        <td data-label="S·ªë l∆∞·ª£ng">
                            <input type="number"
                                   name="quantity"
                                   th:value="${it.quantity}"
                                   min="1"
                                   class="qty-input"
                                   style="width: 60px; padding: 4px;"
                                   th:attr="data-item-id=${it.cartItemId}">
                        </td>

                        <!-- TH√ÄNH TI·ªÄN: th√™m class + data-item-id ƒë·ªÉ JS update -->
                        <td data-label="Th√†nh ti·ªÅn"
                            class="line-total"
                            th:attr="data-item-id=${it.cartItemId}"
                            th:text="${#numbers.formatDecimal(it.unitPrice * it.quantity, 0, 'COMMA', 0, 'POINT')} + ' VND'">
                            0
                        </td>

                        <!-- N√öT X√ìA -->
                        <td data-label="X√≥a">
                            <form th:action="@{/cart/remove}" method="post">
                                <input type="hidden" name="cartItemId" th:value="${it.cartItemId}" />
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                                <button type="submit" class="action-btn delete-trigger" title="X√≥a s·∫£n ph·∫©m">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    </tbody>

                    <tfoot>
                    <tr>
                        <th colspan="3">T·ªïng ti·ªÅn</th>
                        <th id="cart-total"
                            th:text="${#numbers.formatDecimal(cart.getTotalAmount(), 0, 'COMMA', 0, 'POINT')} + ' VND'">
                            0
                        </th>
                    </tr>
                    </tfoot>
                </table>

                <div class="checkout">
                    <form th:action="@{/orders/create}" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <button type="submit" class="cta-button">Ti·∫øn h√†nh Thanh to√°n</button>
                    </form>
                </div>
            </div>

        </div>
    </div>
</main>

<footer class="site-footer">
    <div class="container">
        <p>&copy; 2025 GymCare. ƒê√£ ƒëƒÉng k√Ω b·∫£n quy·ªÅn.</p>
    </div>
</footer>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const navbar = document.querySelector('.navbar');
        if (navbar) {
            window.addEventListener('scroll', () => {
                if (window.scrollY > 50) {
                    navbar.classList.add('scrolled');
                } else {
                    navbar.classList.remove('scrolled');
                }
            });
        }

        const profileDropdown = document.querySelector('.profile-dropdown');
        if (profileDropdown) {
            profileDropdown.addEventListener('click', (e) => {
                if (!e.target.closest('a')) {
                    profileDropdown.classList.toggle('active');
                }
            });

            document.addEventListener('click', (e) => {
                if (profileDropdown && !profileDropdown.contains(e.target)) {
                    profileDropdown.classList.remove('active');
                }
            });
        }

        // ====== PH·∫¶N AJAX UPDATE S·ªê L∆Ø·ª¢NG ======
        const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

        const qtyInputs = document.querySelectorAll('.qty-input');

        qtyInputs.forEach(input => {
            input.addEventListener('change', function () {
                const newQty = parseInt(this.value, 10);
                const itemId = this.getAttribute('data-item-id');

                if (!itemId || isNaN(newQty) || newQty <= 0) {
                    alert('S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá');
                    return;
                }

                const params = new URLSearchParams();
                params.append('itemId', itemId);
                params.append('quantity', newQty);

                fetch('/cart/update-item-ajax', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        ...(csrfHeader && csrfToken ? { [csrfHeader]: csrfToken } : {})
                    },
                    body: params.toString()
                })
                    .then(res => res.json())
                    .then(data => {
                        if (!data.success) {
                            alert(data.message || 'C·∫≠p nh·∫≠t th·∫•t b·∫°i');
                            return;
                        }

                        // update l·∫°i quantity (ph√≤ng tr∆∞·ªùng h·ª£p server ƒëi·ªÅu ch·ªânh)
                        input.value = data.quantity;

                        // c·∫≠p nh·∫≠t th√†nh ti·ªÅn d√≤ng n√†y
                        const lineCell = document.querySelector(
                            '.line-total[data-item-id="' + data.itemId + '"]'
                        );
                        if (lineCell) {
                            lineCell.textContent = data.lineTotal.toLocaleString('vi-VN') + ' VND';
                        }

                        // c·∫≠p nh·∫≠t t·ªïng ti·ªÅn gi·ªè h√†ng
                        const cartTotalCell = document.getElementById('cart-total');
                        if (cartTotalCell) {
                            cartTotalCell.textContent = data.cartTotal.toLocaleString('vi-VN') + ' VND';
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t gi·ªè h√†ng');
                    });
            });
        });
        // ====== H·∫æT PH·∫¶N AJAX ======
    });
</script>

</body>
</html>
